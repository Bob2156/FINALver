<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MFEA Testing</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f5f5f5; }
    h1 { color: #0070f3; }
    .controls { margin: 20px 0; }
    input, select, button { padding: 8px; font-size: 14px; margin: 0 5px; }
    .result, .error { margin-top: 10px; }
    .chart-container { width: 90%; max-width: 800px; height: 400px; margin: 30px auto; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    canvas { width: 100% !important; height: 100% !important; }
  </style>
</head>
<body>
  <h1>MFEA Testing</h1>

  <div class="controls">
    <!-- Ticker controls -->
    <input type="text" id="tickerInput" placeholder="Ticker (e.g. AAPL)" />
    <select id="rangeSelect">
      <option value="1d">1 Day</option>
      <option value="1mo">1 Month</option>
      <option value="1y">1 Year</option>
      <option value="3y">3 Years</option>
      <option value="10y">10 Years</option>
    </select>
    <button id="tickerBtn">Get Ticker</button>
    <div class="result" id="tickerResult"></div>
    <div class="error"  id="tickerError"></div>
    <div class="chart-container"><canvas id="tickerChart"></canvas></div>
  </div>

  <hr/>

  <div class="controls">
    <!-- MFEA /check controls -->
    <button id="mfeaBtn">Run MFEA Analysis</button>
    <div class="result" id="mfeaResult"></div>
    <div class="error"  id="mfeaError"></div>
    <div class="chart-container"><canvas id="mfeaChart"></canvas></div>
  </div>

  <script>
    let tickerChart, mfeaChart;

    // Helper to destroy old chart
    function resetChart(chart) {
      if (chart) {
        chart.destroy();
        return null;
      }
      return null;
    }

    // TICKER
    document.getElementById("tickerBtn").onclick = async () => {
      const t = document.getElementById("tickerInput").value.trim().toUpperCase();
      const r = document.getElementById("rangeSelect").value;
      const resDiv = document.getElementById("tickerResult");
      const errDiv = document.getElementById("tickerError");
      resDiv.textContent = ""; errDiv.textContent = "";
      tickerChart = resetChart(tickerChart);

      if (!t) return errDiv.textContent = "Enter a ticker.";

      try {
        resDiv.textContent = "Loading…";
        const resp = await fetch(`/api/fetchData?ticker=${t}&range=${r}`);
        if (!resp.ok) throw await resp.json();
        const data = await resp.json();

        // Display text info
        resDiv.innerHTML = `<strong>${data.ticker}</strong> — Current Price: ${data.currentPrice}`;

        // Build chart
        const ctx = document.getElementById("tickerChart").getContext("2d");
        tickerChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.historicalData.map(e => e.date),
            datasets: [{
              label: `${data.ticker} Price`,
              data: data.historicalData.map(e => e.price),
              borderColor: '#0070f3',
              backgroundColor: 'rgba(0,112,243,0.1)',
              borderWidth: 2, pointRadius: 0, fill: true
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx => ` $${parseFloat(ctx.parsed.y).toFixed(2)}`
                }
              }
            },
            scales: {
              x: { title: { display: true, text: 'Date' }, ticks: { maxRotation:0,minRotation:0 } },
              y: { title: { display: true, text: 'Price ($)' } }
            }
          }
        });

      } catch (err) {
        errDiv.textContent = err.error || err.message || "Failed to fetch ticker.";
      }
    };

    // MFEA ANALYSIS
    document.getElementById("mfeaBtn").onclick = async () => {
      const resDiv = document.getElementById("mfeaResult");
      const errDiv = document.getElementById("mfeaError");
      resDiv.textContent = ""; errDiv.textContent = "";
      mfeaChart = resetChart(mfeaChart);

      try {
        resDiv.textContent = "Loading…";
        const resp = await fetch(`/api/fetchData?type=check`);
        if (!resp.ok) throw await resp.json();
        const d = await resp.json();

        // Text summary
        resDiv.innerHTML = `
          SPY: $${d.spy}, 220‑day SMA: $${d.sma220} (${d.spyStatus})<br/>
          Volatility (21d): ${d.volatility}%<br/>
          3‑mo Rate: ${d.treasuryRate}% ${d.treasuryTrend}<br/>
          <strong>MFEA →</strong> ${d.mfeaCategory}: ${d.mfeaAllocation}<br/>
          <strong>⸺ Recommended →</strong> ${d.recommendedCategory}: ${d.recommendedAllocation}<br/>
          <em>${d.bandInfluenceDescription}</em>
        `;

        // Chart: SPY price vs constant SMA
        const ctx2 = document.getElementById("mfeaChart").getContext("2d");
        mfeaChart = new Chart(ctx2, {
          type: 'line',
          data: {
            labels: d.priceHistory.map(e => e.date),
            datasets: [
              {
                label: 'SPY Price',
                data: d.priceHistory.map(e => e.price),
                borderColor: '#0070f3',
                backgroundColor: 'rgba(0,112,243,0.1)',
                borderWidth: 2, pointRadius: 0, fill: false
              },
              {
                label: '220‑day SMA',
                data: d.smaHistory.map(e => e.sma),
                borderColor: '#ff6600',
                borderDash: [5,5],
                pointRadius: 0, fill: false
              }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
              x: { title: { display: true, text: 'Date' } },
              y: { title: { display: true, text: 'Price ($)' } }
            }
          }
        });

      } catch (err) {
        errDiv.textContent = err.error || err.message || "Failed to run MFEA.";
      }
    };
  </script>
</body>
</html>
